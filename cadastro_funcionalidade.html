<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Funcionalidades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos adicionais para o layout */
        #visualizacao-detalhada {
            display: none; /* Inicialmente oculto */
            flex-direction: row;
            gap: 20px;
            margin-top: 20px;
        }

        #detalhes-funcionalidade-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
        }

        #chat-gpt-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex: 1;
        }

        #chat-gpt-container textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            resize: vertical;
        }

        #chat-gpt-container button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        #chat-gpt-container button:hover {
            background-color: #45a049;
        }

        .fechar-visualizacao {
            background-color: #f44336;
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            display: inline-block;
        }

        .fechar-visualizacao:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-6">

    <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">Funcionalidades</h1>
        <button onclick="abrirModalCadastro()" class="bg-blue-600 text-white px-4 py-2 rounded">Nova Funcionalidade</button>
    </div>

    <table class="w-full bg-white shadow-md rounded overflow-hidden">
        <thead class="bg-blue-600 text-white">
            <tr>
                <th class="p-3 text-left">Funcionalidade</th>
                <th class="p-3 text-left">Prioridade</th>
                <th class="p-3 text-left">Relator</th>
                <th class="p-3 text-left">Criado em</th>
                <th class="p-3">Ações</th>
            </tr>
        </thead>
        <tbody id="tabela-funcionalidades" class="divide-y divide-gray-200">
            </tbody>
    </table>

    <div id="modal-cadastro" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
        <div class="bg-white p-6 rounded shadow-md w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4">Nova Funcionalidade</h2>
            <form id="formFuncionalidade">
                <input type="hidden" name="id">
                <input type="hidden" name="imagem_existente">
                <input class="w-full mb-2 p-2 border rounded" placeholder="Funcionalidade" name="nome" required>
                <input class="w-full mb-2 p-2 border rounded" placeholder="Relator" name="relator" id="relator" required>
                <select class="w-full mb-2 p-2 border rounded" name="prioridade" required>
                    <option value="Alta">Alta</option>
                    <option value="Média">Média</option>
                    <option value="Baixa">Baixa</option>
                </select>
                <textarea class="w-full mb-2 p-2 border rounded" placeholder="Descrição" name="descricao"></textarea>
                <input type="file" class="mb-2" name="imagem">
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="fecharModalCadastro()" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="visualizacao-detalhada" class="hidden">
        <div id="detalhes-funcionalidade-container">
            <h2 class="text-xl font-semibold mb-4">Detalhes da Funcionalidade</h2>
            <div id="detalhes-funcionalidade">
                <p><strong>Nome:</strong> <span id="visualizar-nome"></span></p>
                <p><strong>Relator:</strong> <span id="visualizar-relator"></span></p>
                <p><strong>Prioridade:</strong> <span id="visualizar-prioridade"></span></p>
                <p><strong>Descrição:</strong> <span id="visualizar-descricao"></span></p>
                <p><strong>Criado em:</strong> <span id="visualizar-criado_em"></span></p>
                <p><strong>Anexo:</strong> <span id="visualizar-imagem-link"></span></p>
            </div>
            <button onclick="fecharVisualizacaoDetalhada()" class="fechar-visualizacao">Fechar Detalhes</button>
        </div>
        <div id="chat-gpt-container">
            <h2 class="text-xl font-semibold mb-4">Prompt ChatGPT</h2>
            <textarea id="prompt-visualizacao" placeholder="Digite seu prompt relacionado a esta funcionalidade..." readonly></textarea>
            <button onclick="enviarPromptVisualizacao()">Gerar Casos de Teste</button>
            <div id="resposta-visualizacao" class="mt-4 p-3 border rounded bg-gray-100">A resposta aparecerá aqui...</div>
        </div>
    </div>

    <script>
        const modalCadastro = document.getElementById('modal-cadastro');
        const visualizacaoDetalhada = document.getElementById('visualizacao-detalhada');
        const detalhesFuncionalidadeContainer = document.getElementById('detalhes-funcionalidade');
        const tabela = document.getElementById('tabela-funcionalidades');
        const visualizarNome = document.getElementById('visualizar-nome');
        const visualizarRelator = document.getElementById('visualizar-relator');
        const visualizarPrioridade = document.getElementById('visualizar-prioridade');
        const visualizarDescricao = document.getElementById('visualizar-descricao');
        const visualizarCriadoEm = document.getElementById('visualizar-criado_em');
        const visualizarImagemLink = document.getElementById('visualizar-imagem-link');
        const promptVisualizacaoInput = document.getElementById('prompt-visualizacao');
        const respostaVisualizacaoDiv = document.getElementById('resposta-visualizacao');
        const formFuncionalidade = document.getElementById('formFuncionalidade');
        const modalTitle = document.querySelector('#modal-cadastro h2');
        const salvarButton = document.querySelector('#formFuncionalidade button[type="submit"]');
        const idFuncionalidadeEdicaoInput = formFuncionalidade.querySelector('[name="id"]');

        function abrirModalCadastro() {
            modalTitle.textContent = 'Nova Funcionalidade';
            salvarButton.textContent = 'Salvar';
            formFuncionalidade.reset();
            idFuncionalidadeEdicaoInput.value = ''; // Limpa o ID para novo cadastro
            const imagemExistenteInput = formFuncionalidade.querySelector('[name="imagem_existente"]');
            if (imagemExistenteInput) {
                imagemExistenteInput.remove();
            }
            modalCadastro.classList.remove('hidden');
        }

        function fecharModalCadastro() {
            modalCadastro.classList.add('hidden');
        }

        function abrirVisualizacaoDetalhada(funcionalidade) {
            console.log("Função abrirVisualizacaoDetalhada chamada:", funcionalidade);
            console.log("Elemento visualizacaoDetalhada:", visualizacaoDetalhada);
            visualizarNome.textContent = funcionalidade.nome;
            visualizarRelator.textContent = funcionalidade.relator;
            visualizarPrioridade.textContent = funcionalidade.prioridade;
            visualizarDescricao.textContent = funcionalidade.descricao || 'Nenhuma descrição';
            visualizarCriadoEm.textContent = new Date(funcionalidade.criado_em).toLocaleDateString();

            if (funcionalidade.imagem) {
                const link = document.createElement('a');
                link.href = `http://localhost:8000/uploads/${funcionalidade.imagem.split('/').pop()}`;
                link.textContent = funcionalidade.imagem.split('/').pop();
                link.target = '_blank';
                visualizarImagemLink.innerHTML = '';
                visualizarImagemLink.appendChild(link);
            } else {
                visualizarImagemLink.textContent = 'Nenhum anexo';
            }

            promptVisualizacaoInput.value = funcionalidade.descricao || '';
            visualizacaoDetalhada.style.display = 'flex';
        }

        function fecharVisualizacaoDetalhada() {
            visualizacaoDetalhada.style.display = 'none';
        }

        function abrirModalEdicao(funcionalidade) {
            modalTitle.textContent = 'Editar Funcionalidade';
            salvarButton.textContent = 'Atualizar';
            formFuncionalidade.reset();

            formFuncionalidade.querySelector('[name="nome"]').value = funcionalidade.nome;
            formFuncionalidade.querySelector('[name="relator"]').value = funcionalidade.relator;
            formFuncionalidade.querySelector('[name="prioridade"]').value = funcionalidade.prioridade;
            formFuncionalidade.querySelector('[name="descricao"]').value = funcionalidade.descricao || '';
            idFuncionalidadeEdicaoInput.value = funcionalidade.id || '';

            // Verifica se a funcionalidade tem uma imagem e adiciona/atualiza o campo oculto com o nome
            let imagemExistenteInput = formFuncionalidade.querySelector('[name="imagem_existente"]');
            if (funcionalidade.imagem) {
                if (!imagemExistenteInput) {
                    imagemExistenteInput = document.createElement('input');
                    imagemExistenteInput.type = 'hidden';
                    imagemExistenteInput.name = 'imagem_existente';
                    formFuncionalidade.appendChild(imagemExistenteInput);
                }
                imagemExistenteInput.value = funcionalidade.imagem.split('/').pop();
            } else if (imagemExistenteInput) {
                imagemExistenteInput.remove(); // Remove o campo oculto se não houver imagem
            }

            modalCadastro.classList.remove('hidden');
        }

        async function carregarFuncionalidades() {
            const res = await fetch("http://localhost:8000/funcionalidades");
            const funcionalidades = await res.json();
            tabela.innerHTML = funcionalidades.map(f => `
                <tr>
                    <td class="p-3">${f.nome}</td>
                    <td class="p-3">${f.prioridade}</td>
                    <td class="p-3">${f.relator}</td>
                    <td class="p-3">${new Date(f.criado_em).toLocaleDateString()}</td>
                    <td class="p-3">
                        <button onclick='abrirVisualizacaoDetalhada(${JSON.stringify(f)})' class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-2 rounded mr-2">Visualizar</button>
                        <button onclick='abrirModalEdicao(${JSON.stringify(f)})' class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1 px-2 rounded">Editar</button>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('formFuncionalidade').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = new FormData(e.target);
            const idEdicao = form.get('id');
            let url = "http://localhost:8000/funcionalidades";
            let method = 'POST';

            if (idEdicao) {
                url = `http://localhost:8000/funcionalidades/${idEdicao}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                body: form
            });

            if (response.ok) {
                e.target.reset();
                fecharModalCadastro();
                carregarFuncionalidades();
                alert(`Funcionalidade ${idEdicao ? 'atualizada' : 'cadastrada'} com sucesso!`);
            } else {
                const errorData = await response.json();
                alert(`Erro ao ${idEdicao ? 'atualizar' : 'cadastrar'} funcionalidade: ${errorData.detail || response.statusText}`);
                console.error(errorData);
            }
        });

        async function enviarPromptVisualizacao() {
            const prompt = promptVisualizacaoInput.value;
            respostaVisualizacaoDiv.textContent = "Pensando...";

            try {
                // Adapte a URL e a estrutura do body conforme a sua API do ChatGPT
                const response = await fetch("http://localhost:8000/generate_bdd", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_story: prompt }) // Ou outra estrutura esperada pela sua API
                });

                const data = await response.json();

                if (response.ok) {
                    respostaVisualizacaoDiv.textContent = data.bdd_scenarios || "Resposta gerada.";
                } else {
                    respostaVisualizacaoDiv.textContent = `Erro na requisição: ${data.detail || response.statusText}`;
                }
            } catch (error) {
                respostaVisualizacaoDiv.textContent = "Erro ao comunicar com o servidor.";
                console.error(error);
            }
        }

        window.onload = carregarFuncionalidades;
    </script>

</body>
</html>