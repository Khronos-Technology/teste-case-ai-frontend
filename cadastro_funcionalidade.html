<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Funcionalidades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Seção de Estilos Customizados */
        .imagem-preview {
            font-size: 0.875rem; /* Equivalente a text-sm no Tailwind */
            color: #6b7280; /* Equivalente a text-gray-500 no Tailwind */
            margin-top: 0.25rem; /* Equivalente a mt-1 no Tailwind */
        }

        /* Estilo para o dropdown de ações */
        #actionsDropdown {
            position: absolute;
            z-index: 1000; /* Garante que o dropdown fique acima de outros elementos */
            min-width: 150px; /* Adicione uma largura mínima para evitar que ele seja muito estreito */
            box-sizing: border-box; /* Garante que padding e border sejam incluídos na largura */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <nav class="bg-blue-900 text-white p-4 flex justify-between items-center">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7 text-green-400 mr-2">
                <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
            </svg>
            <span class="text-xl font-bold">testcaseAI</span>
        </div>
        <div class="flex items-center space-x-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 0 12 21.75c-2.676 0-5.216-.584-7.5-1.632Z" />
            </svg>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.17.992c.07.4-.108.803-.472 1.068L15.7 7.5c-.347.24-.555.626-.54 1.03l.02.246c.01.29.157.564.407.743l1.192.857c.414.295.667.817.625 1.356l-.088 1.302c-.04.53-.466.96-.995 1.077l-.966.233c-.4.096-.75.32-.977.658L12 18.88c-.227.338-.577.562-.977.658l-.966-.233c-.529-.117-.955-.546-.995-1.076l-.088-1.302c-.042-.539.21-1.061.625-1.356l1.192-.857c.25-.179.397-.453.407-.743l.02-.246c.015-.403-.153-.789-.5-1.03l-2.07-1.5c-.364-.265-.542-.668-.472-1.068l.17-.992Zm.974 6.84a2 2 0 1 0 2.21-3.328 2 0 0 0-2.21 3.328Z" />
            </svg>
            <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md text-sm ml-4">Sair</button>
        </div>
    </nav>

    <div class="bg-blue-900 text-white p-2 flex justify-start items-center space-x-4 px-4">
        <button class="bg-blue-700 px-4 py-2 rounded-md font-semibold">Casos de teste</button>
        <button class="bg-blue-800 hover:bg-blue-700 px-4 py-2 rounded-md font-medium text-gray-300 hover:text-white">Área de trabalho</button>
        <button class="bg-blue-800 hover:bg-blue-700 px-4 py-2 rounded-md font-medium text-gray-300 hover:text-white">Testes em execução</button>
    </div>

    <div class="p-6">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold">Funcionalidades</h2>
            <button title="Nova Funcionalidade" onclick="UI.abrirModalCadastro()" class="bg-green-500 hover:bg-green-600 text-white font-bold p-2 rounded-md">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
            </button>
        </div>

        <h3 class="text-lg font-semibold mb-2">Lista de Casos de teste</h3>

        <table class="w-full bg-white shadow-md rounded-md overflow-hidden">
            <thead class="bg-blue-500 text-white">
                <tr>
                    <th class="p-3 text-center w-8">
                        <input type="checkbox" id="selectAllCheckbox" class="form-checkbox h-4 w-4 text-blue-600">
                    </th>
                    <th class="p-3 text-left">Projeto</th>
                    <th class="p-3 text-left">Funcionalidade</th>
                    <th class="p-3 text-left">Prioridade</th>
                    <th class="p-3 text-left">Relator</th>
                    <th class="p-3 text-center">Ações</th>
                </tr>
            </thead>
            <tbody id="tabela-funcionalidades" class="divide-y divide-gray-200">
            </tbody>
        </table>
    </div>

    <div id="actionsDropdown" class="bg-white border border-gray-200 rounded-md shadow-lg hidden">
    </div>

    <div id="modal-cadastro" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
        <div class="bg-white p-6 rounded-md shadow-lg w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4">Nova Funcionalidade</h2>
            <form id="formFuncionalidade" class="space-y-4">
                <input type="hidden" name="id">
                <input type="hidden" name="imagem_existente">
                <div>
                    <input class="w-full p-2 border rounded-md" placeholder="Funcionalidade" name="nome" required>
                </div>
                <div>
                    <input class="w-full p-2 border rounded-md" placeholder="Relator" name="relator" id="relator" required>
                </div>
                <div>
                    <select class="w-full p-2 border rounded-md" name="prioridade" required>
                        <option value="Alta">Alta</option>
                        <option value="Média">Média</option>
                        <option value="Baixa">Baixa</option>
                    </select>
                </div>
                <div>
                    <textarea class="w-full p-2 border rounded-md" placeholder="Descrição" name="descricao"></textarea>
                </div>
                <div>
                    <label for="imagem" class="block text-gray-700 text-sm font-bold mb-2">Anexo:</label>
                    <input type="file" class="w-full" name="imagem" id="imagem">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="UI.fecharModalCadastro()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Cancelar</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="visualizacao-detalhada" class="hidden flex gap-6 mt-6 p-6">
        <div id="detalhes-funcionalidade-container" class="bg-white p-6 rounded-md shadow-md flex-1">
            <h2 class="text-xl font-semibold mb-4">Detalhes da Funcionalidade</h2>
            <div id="detalhes-funcionalidade" class="space-y-2">
                <p><strong class="font-semibold">Nome:</strong> <span id="visualizar-nome"></span></p>
                <p><strong class="font-semibold">Relator:</strong> <span id="visualizar-relator"></span></p>
                <p><strong class="font-semibold">Prioridade:</strong> <span id="visualizar-prioridade"></span></p>
                <p><strong class="font-semibold">Descrição:</strong> <span id="visualizar-descricao"></span></p>
                <p><strong class="font-semibold">Criado em:</strong> <span id="visualizar-criado_em"></span></p>
                <p><strong class="font-semibold">Anexo:</strong> <span id="visualizar-imagem-link"></span></p>
            </div>
            <button onclick="UI.fecharVisualizacaoDetalhada()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md mt-4 inline-block">Fechar Detalhes</button>
        </div>
        <div id="chat-gpt-container" class="bg-white p-6 rounded-md shadow-md flex-1">
            <h2 class="text-xl font-semibold mb-4">Prompt ChatGPT</h2>
            <textarea id="prompt-visualizacao" class="w-full p-2 border rounded-md mb-4" placeholder="Digite seu prompt relacionado a esta funcionalidade..." readonly></textarea>
            <button onclick="APIs.enviarPromptVisualizacao()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md">Gerar Casos de Teste</button>
            <div id="resposta-visualizacao" class="mt-4 p-3 border rounded-md bg-gray-100 whitespace-pre-wrap overflow-y-auto max-h-96">A resposta aparecerá aqui...</div>
        </div>
    </div>

    <script>
        // Função para verificar a autenticação ao carregar a página
        function checkAuthentication() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                // Redireciona para a página de login se não houver token
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // Adiciona um listener para o botão de sair
        document.getElementById('logoutButton').addEventListener('click', function() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('token_type');
            window.location.href = 'index.html';
        });

        // Objeto para gerenciar elementos da UI
        const UI = {
            modalCadastro: document.getElementById('modal-cadastro'),
            visualizacaoDetalhada: document.getElementById('visualizacao-detalhada'),
            detalhesFuncionalidadeContainer: document.getElementById('detalhes-funcionalidade'),
            tabela: document.getElementById('tabela-funcionalidades'),
            visualizarNome: document.getElementById('visualizar-nome'),
            visualizarRelator: document.getElementById('visualizar-relator'),
            visualizarPrioridade: document.getElementById('visualizar-prioridade'),
            visualizarDescricao: document.getElementById('visualizar-descricao'),
            visualizarCriadoEm: document.getElementById('visualizar-criado_em'),
            visualizarImagemLink: document.getElementById('visualizar-imagem-link'),
            promptVisualizacaoInput: document.getElementById('prompt-visualizacao'),
            respostaVisualizacaoDiv: document.getElementById('resposta-visualizacao'),
            formFuncionalidade: document.getElementById('formFuncionalidade'),
            modalTitle: document.querySelector('#modal-cadastro h2'),
            salvarButton: document.querySelector('#formFuncionalidade button[type="submit"]'),
            idFuncionalidadeEdicaoInput: document.getElementById('formFuncionalidade').querySelector('[name="id"]'),
            actionsDropdown: document.getElementById('actionsDropdown'),
            currentActionButton: null,
            selectAllCheckbox: document.getElementById('selectAllCheckbox'),

            // Métodos para controle de modais e dropdowns
            abrirModalCadastro: function() {
                this.modalTitle.textContent = 'Nova Funcionalidade';
                this.salvarButton.textContent = 'Salvar';
                this.formFuncionalidade.reset();
                this.idFuncionalidadeEdicaoInput.value = '';
                const imagemExistenteInput = this.formFuncionalidade.querySelector('[name="imagem_existente"]');
                if (imagemExistenteInput) {
                    imagemExistenteInput.value = ''; // Limpa o valor para nova funcionalidade
                }
                const imagemPreview = this.formFuncionalidade.querySelector('.imagem-preview');
                if (imagemPreview) {
                    imagemPreview.remove();
                }
                this.modalCadastro.classList.remove('hidden');
            },

            fecharModalCadastro: function() {
                this.modalCadastro.classList.add('hidden');
            },

            abrirVisualizacaoDetalhada: function(funcionalidade) {
                this.visualizarNome.textContent = funcionalidade.nome;
                this.visualizarRelator.textContent = funcionalidade.relator;
                this.visualizarPrioridade.textContent = funcionalidade.prioridade;
                this.visualizarDescricao.textContent = funcionalidade.descricao || 'Nenhuma descrição';
                this.visualizarCriadoEm.textContent = new Date(funcionalidade.criado_em).toLocaleDateString();

                if (funcionalidade.imagem) {
                    const link = document.createElement('a');
                    // Certifique-se que o caminho da imagem está correto.
                    // Se o backend retorna apenas o nome do arquivo, você precisa concatenar com a URL base de uploads.
                    const nomeArquivo = funcionalidade.imagem.split('/').pop();
                    link.href = `${APIs.API_BASE_URL}/uploads/${nomeArquivo}`;
                    link.textContent = nomeArquivo;
                    link.target = '_blank';
                    this.visualizarImagemLink.innerHTML = '';
                    this.visualizarImagemLink.appendChild(link);
                } else {
                    this.visualizarImagemLink.textContent = 'Nenhum anexo';
                }

                this.promptVisualizacaoInput.value = funcionalidade.descricao || '';
                this.visualizacaoDetalhada.dataset.currentId = funcionalidade.id;
                this.visualizacaoDetalhada.classList.remove('hidden');
            },

            fecharVisualizacaoDetalhada: function() {
                this.visualizacaoDetalhada.classList.add('hidden');
                delete this.visualizacaoDetalhada.dataset.currentId;
                this.respostaVisualizacaoDiv.textContent = "A resposta aparecerá aqui..."; // Limpa a resposta do ChatGPT
            },

            abrirModalEdicao: function(funcionalidade) {
                this.modalTitle.textContent = 'Editar Funcionalidade';
                this.salvarButton.textContent = 'Atualizar';
                this.formFuncionalidade.reset();

                this.formFuncionalidade.querySelector('[name="nome"]').value = funcionalidade.nome;
                this.formFuncionalidade.querySelector('[name="relator"]').value = funcionalidade.relator;
                this.formFuncionalidade.querySelector('[name="prioridade"]').value = funcionalidade.prioridade;
                this.formFuncionalidade.querySelector('[name="descricao"]').value = funcionalidade.descricao || '';
                this.idFuncionalidadeEdicaoInput.value = funcionalidade.id || '';

                let imagemInput = this.formFuncionalidade.querySelector('[name="imagem"]');
                let imagemExistenteInput = this.formFuncionalidade.querySelector('[name="imagem_existente"]');
                let imagemPreview = this.formFuncionalidade.querySelector('.imagem-preview');

                // Lida com a imagem existente ao abrir o modal de edição
                if (funcionalidade.imagem) {
                    const nomeArquivo = funcionalidade.imagem.split('/').pop();
                    if (!imagemExistenteInput) {
                        imagemExistenteInput = document.createElement('input');
                        imagemExistenteInput.type = 'hidden';
                        imagemExistenteInput.name = 'imagem_existente'; // Use o nome do input oculto
                        this.formFuncionalidade.appendChild(imagemExistenteInput);
                    }
                    imagemExistenteInput.value = nomeArquivo; // Armazena o nome do arquivo existente

                    if (!imagemPreview) {
                        imagemPreview = document.createElement('div');
                        imagemPreview.className = 'imagem-preview text-sm text-gray-500 mt-1';
                        // Insere o preview abaixo do input de arquivo
                        imagemInput.parentNode.insertBefore(imagemPreview, imagemInput.nextSibling);
                    }
                    imagemPreview.innerHTML = `Arquivo atual: <strong>${nomeArquivo}</strong> <button type="button" class="text-red-500 hover:text-red-700 ml-2" onclick="UI.removerImagemExistente()">Remover</button>`;
                } else {
                    // Limpa qualquer informação de imagem existente se não houver uma
                    if (imagemExistenteInput) {
                        imagemExistenteInput.value = '';
                    }
                    if (imagemPreview) {
                        imagemPreview.remove();
                    }
                }
                // Limpa o input de arquivo para que o usuário precise explicitamente selecionar um novo
                imagemInput.value = '';

                this.modalCadastro.classList.remove('hidden');
            },

            removerImagemExistente: function() {
                const imagemExistenteInput = this.formFuncionalidade.querySelector('[name="imagem_existente"]');
                if (imagemExistenteInput) {
                    imagemExistenteInput.value = ''; // Define o valor como vazio para indicar remoção
                }
                const imagemPreview = this.formFuncionalidade.querySelector('.imagem-preview');
                if (imagemPreview) {
                    imagemPreview.remove(); // Remove o texto de preview
                }
                alert('A imagem será removida ao salvar esta funcionalidade, a menos que você selecione uma nova imagem.');
            },

            // Função para alternar o dropdown de ações
            toggleActionsDropdown: function(event, funcionalidadeId, nomeFuncionalidade) {
                const button = event.currentTarget;
                if (this.currentActionButton === button && !this.actionsDropdown.classList.contains('hidden')) {
                    this.actionsDropdown.classList.add('hidden');
                    this.currentActionButton = null;
                    return;
                }

                this.currentActionButton = button;
                this.actionsDropdown.innerHTML = ''; // Limpa o conteúdo anterior

                const dropdownItems = [
                    { text: 'Visualizar', action: `APIs.carregarDetalhesFuncionalidade(${funcionalidadeId})` },
                    { text: 'Editar', action: `APIs.carregarParaEdicao(${funcionalidadeId})` },
                    { text: 'Excluir', action: `APIs.deletarFuncionalidade(${funcionalidadeId}, '${nomeFuncionalidade}')` }
                ];

                dropdownItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                    div.textContent = item.text;
                    div.onclick = () => {
                        eval(item.action); // Executa a ação
                        this.actionsDropdown.classList.add('hidden'); // Fecha o dropdown
                    };
                    this.actionsDropdown.appendChild(div);
                });

                // Posiciona o dropdown
                const rect = button.getBoundingClientRect();
                this.actionsDropdown.style.top = `${rect.bottom + window.scrollY + 5}px`;
                this.actionsDropdown.style.left = `${rect.left + window.scrollX}px`;
                this.actionsDropdown.classList.remove('hidden');
            },

            fecharActionsDropdown: function() {
                this.actionsDropdown.classList.add('hidden');
                this.currentActionButton = null;
            }
        };

        // Objeto para gerenciar as chamadas de API
        const APIs = {
            API_BASE_URL: "http://localhost:8000", // Certifique-se de que esta URL está correta

            // Função para obter os headers de autenticação
            getAuthHeaders: function() {
                const token = localStorage.getItem('access_token');
                const tokenType = localStorage.getItem('token_type');
                if (token && tokenType) {
                    return {
                        'Authorization': `${tokenType} ${token}`,
                        'Content-Type': 'application/json' // Default para JSON, pode ser sobrescrito
                    };
                }
                // Redireciona para o login se não houver token, o que já é feito em checkAuthentication()
                window.location.href = 'index.html';
                throw new Error("Token de autenticação não encontrado. Redirecionando para o login.");
            },

            listarFuncionalidades: async function() {
                try {
                    const headers = this.getAuthHeaders();
                    delete headers['Content-Type']; // GET request, não precisa de Content-Type

                    const response = await fetch(`${this.API_BASE_URL}/funcionalidades`, {
                        method: 'GET',
                        headers: headers
                    });
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Sessão expirada ou não autorizada. Por favor, faça login novamente.');
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('token_type');
                            window.location.href = 'index.html';
                            return [];
                        }
                        throw new Error(`Erro ao listar funcionalidades: ${response.statusText}`);
                    }
                    const funcionalidades = await response.json();
                    UI.tabela.innerHTML = ''; // Limpa a tabela antes de popular
                    funcionalidades.forEach(funcionalidade => {
                        const row = UI.tabela.insertRow();
                        row.innerHTML = `
                            <td class="p-3 text-center">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 item-checkbox">
                            </td>
                            <td class="p-3">Projeto X</td>
                            <td class="p-3">${funcionalidade.nome}</td>
                            <td class="p-3">${funcionalidade.prioridade}</td>
                            <td class="p-3">${funcionalidade.relator}</td>
                            <td class="p-3 text-center relative">
                                <button onclick="UI.toggleActionsDropdown(event, ${funcionalidade.id}, '${funcionalidade.nome}')" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM12.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0ZM18.75 12a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                                    </svg>
                                </button>
                            </td>
                        `;
                    });
                    return funcionalidades;
                } catch (error) {
                    console.error("Erro ao listar funcionalidades:", error);
                    return [];
                }
            },

            salvarFuncionalidade: async function(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const funcionalidadeId = form.querySelector('[name="id"]').value;

                // --- Correção Principal AQUI ---
                const imagemInput = form.querySelector('[name="imagem"]');
                const imagemExistenteInput = form.querySelector('[name="imagem_existente"]');

                // Se o usuário NÃO selecionou uma nova imagem (input de arquivo está vazio)
                // E existe um valor no campo hidden 'imagem_existente' (ou seja, havia uma imagem antes)
                if (imagemInput.files.length === 0 && imagemExistenteInput && imagemExistenteInput.value) {
                    // Adiciona o nome da imagem existente ao formData
                    // O backend precisará de um campo para saber que a imagem existente deve ser mantida.
                    formData.append('imagem_mantida', imagemExistenteInput.value);
                    // Remove o campo 'imagem' do FormData para não enviar um campo de arquivo vazio
                    formData.delete('imagem');
                } else if (imagemInput.files.length > 0) {
                    // Se uma nova imagem foi selecionada, o FormData já a incluirá.
                    // Garante que o campo 'imagem_mantida' não seja enviado se uma nova imagem for enviada.
                    formData.delete('imagem_mantida');
                } else {
                    // Se não há nova imagem e o campo 'imagem_existente' está vazio (o usuário removeu ou nunca teve)
                    // Isso indica ao backend para remover a imagem.
                    formData.append('remover_imagem', 'true');
                    formData.delete('imagem'); // Garante que nenhum campo vazio seja enviado
                    formData.delete('imagem_mantida');
                }
                // --- Fim da correção ---

                let method = 'POST';
                let url = `${this.API_BASE_URL}/funcionalidades`;
                if (funcionalidadeId) {
                    method = 'PUT';
                    url = `${this.API_BASE_URL}/funcionalidades/${funcionalidadeId}`;
                }

                const headers = {
                    'Authorization': `${localStorage.getItem('token_type')} ${localStorage.getItem('access_token')}`
                };

                // REMOVE o 'Content-Type' para requisições com FormData
                // O navegador define automaticamente o 'multipart/form-data'
                delete headers['Content-Type'];

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: headers,
                        body: formData
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Sessão expirada ou não autorizada. Por favor, faça login novamente.');
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('token_type');
                            window.location.href = 'index.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(`Erro ao salvar funcionalidade: ${errorData.detail || response.statusText}`);
                    }
                    UI.fecharModalCadastro();
                    await this.listarFuncionalidades(); // Recarrega a lista
                    alert(`Funcionalidade ${funcionalidadeId ? 'atualizada' : 'cadastrada'} com sucesso!`); // Feedback ao usuário
                } catch (error) {
                    console.error("Erro ao salvar funcionalidade:", error);
                    alert("Erro ao salvar funcionalidade: " + error.message);
                }
            },

            carregarDetalhesFuncionalidade: async function(id) {
                try {
                    const headers = this.getAuthHeaders();
                    delete headers['Content-Type']; // GET request, não precisa de Content-Type
                    const response = await fetch(`${this.API_BASE_URL}/funcionalidades/${id}`, { // Alterado para buscar por ID
                        method: 'GET',
                        headers: headers
                    });
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Sessão expirada ou não autorizada. Por favor, faça login novamente.');
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('token_type');
                            window.location.href = 'index.html';
                            return;
                        }
                        throw new Error(`Erro ao carregar detalhes: ${response.statusText}`);
                    }
                    const funcionalidade = await response.json(); // Espera um único objeto, não uma lista
                    if (funcionalidade) {
                        UI.abrirVisualizacaoDetalhada(funcionalidade);
                    } else {
                        alert("Funcionalidade não encontrada para visualização.");
                    }
                } catch (error) {
                    console.error("Erro ao carregar detalhes da funcionalidade:", error);
                    alert("Erro ao carregar detalhes: " + error.message);
                }
            },

            carregarParaEdicao: async function(id) {
                try {
                    const headers = this.getAuthHeaders();
                    delete headers['Content-Type']; // GET request, não precisa de Content-Type
                    const response = await fetch(`${this.API_BASE_URL}/funcionalidades/${id}`, { // Alterado para buscar por ID
                        method: 'GET',
                        headers: headers
                    });
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Sessão expirada ou não autorizada. Por favor, faça login novamente.');
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('token_type');
                            window.location.href = 'index.html';
                            return;
                        }
                        throw new Error(`Erro ao carregar funcionalidade para edição: ${response.statusText}`);
                    }
                    const funcionalidade = await response.json(); // Espera um único objeto, não uma lista
                    if (funcionalidade) {
                        UI.abrirModalEdicao(funcionalidade);
                    } else {
                        alert("Funcionalidade não encontrada para edição.");
                    }
                } catch (error) {
                    console.error("Erro ao carregar funcionalidade para edição:", error);
                    alert("Erro ao carregar funcionalidade: " + error.message);
                }
            },

            deletarFuncionalidade: async function(id, nomeFuncionalidade) {
                if (!confirm(`Tem certeza que deseja deletar a funcionalidade "${nomeFuncionalidade}"?`)) {
                    return;
                }
                try {
                    const headers = this.getAuthHeaders();
                    const response = await fetch(`${this.API_BASE_URL}/funcionalidades/${id}`, {
                        method: 'DELETE',
                        headers: headers
                    });
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Sessão expirada ou não autorizada. Por favor, faça login novamente.');
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('token_type');
                            window.location.href = 'index.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(`Erro ao deletar funcionalidade: ${errorData.detail || response.statusText}`);
                    }
                    alert(`Funcionalidade "${nomeFuncionalidade}" deletada com sucesso!`);
                    await this.listarFuncionalidades(); // Recarrega a lista
                } catch (error) {
                    console.error("Erro ao deletar funcionalidade:", error);
                    alert("Erro ao deletar funcionalidade: " + error.message);
                }
            },

            enviarPromptVisualizacao: async function() {
                const userStory = UI.promptVisualizacaoInput.value;
                if (!userStory) {
                    alert("Por favor, digite uma história de usuário para gerar cenários BDD.");
                    return;
                }

                UI.respostaVisualizacaoDiv.textContent = "Gerando cenários BDD...";
                UI.respostaVisualizacaoDiv.style.color = '#4a5568'; // Cor de texto padrão

                try {
                    const response = await fetch(`${this.API_BASE_URL}/generate_bdd`, {
                        method: 'POST',
                        headers: this.getAuthHeaders(), // Isso já retorna Content-Type: application/json
                        body: JSON.stringify({ user_story: userStory, temperature: 0.7 })
                    });

                    if (!response.ok) {
                        if (response.status === 401) {
                            alert('Sessão expirada ou não autorizada. Por favor, faça login novamente.');
                            localStorage.removeItem('access_token');
                            localStorage.removeItem('token_type');
                            window.location.href = 'index.html';
                            return;
                        }
                        const errorData = await response.json();
                        throw new Error(`Erro ao gerar BDD: ${errorData.detail || response.statusText}`);
                    }

                    const data = await response.json();
                    if (data.error) {
                        UI.respostaVisualizacaoDiv.textContent = `Erro do Gemini: ${data.error}`;
                        UI.respostaVisualizacaoDiv.style.color = '#ef5350'; // Vermelho para erro
                    } else {
                        UI.respostaVisualizacaoDiv.textContent = data.bdd_scenarios;
                        UI.respostaVisualizacaoDiv.style.color = '#2d3748'; // Cor de texto escuro para o resultado
                    }
                } catch (error) {
                    console.error("Erro ao chamar a API Gemini:", error);
                    UI.respostaVisualizacaoDiv.textContent = "Erro ao gerar cenários BDD. " + error.message;
                    UI.respostaVisualizacaoDiv.style.color = '#ef5350'; // Vermelho
                }
            }
        };

        // Adiciona o event listener para o formulário no carregamento do DOM.
        // Usamos .bind(APIs) para garantir que 'this' dentro de salvarFuncionalidade
        // sempre se refira ao objeto APIs, onde API_BASE_URL está definida.
        document.addEventListener('DOMContentLoaded', () => {
            if (checkAuthentication()) {
                UI.formFuncionalidade.addEventListener('submit', APIs.salvarFuncionalidade.bind(APIs));
                APIs.listarFuncionalidades();
            }

            // Fechar dropdown de ações ao clicar fora
            document.addEventListener('click', function(event) {
                if (UI.currentActionButton && !UI.actionsDropdown.contains(event.target) && !UI.currentActionButton.contains(event.target)) {
                    UI.fecharActionsDropdown();
                }
            });
        });

    </script>
</body>
</html>