<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Funcionalidades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .imagem-preview {
            font-size: 0.875rem; /* Equivalente a text-sm no Tailwind */
            color: #6b7280; /* Equivalente a text-gray-500 no Tailwind */
            margin-top: 0.25rem; /* Equivalente a mt-1 no Tailwind */
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Funcionalidades</h2>
        <button title="Nova Funcionalidade" onclick="abrirModalCadastro()" class="bg-green-500 hover:bg-green-600 text-white font-bold p-2 rounded-md">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
        </button>
    </div>

    <h3 class="text-lg font-semibold mb-2">Lista de Casos de teste</h3>

    <table class="w-full bg-white shadow-md rounded-md overflow-hidden">
        <thead class="bg-blue-500 text-white">
            <tr>
                <th class="p-3 text-left">Funcionalidade</th>
                <th class="p-3 text-left">Prioridade</th>
                <th class="p-3 text-left">Relator</th>
                <th class="p-3 text-left">Criado em</th>
                <th class="p-3 text-center">Ações</th>
            </tr>
        </thead>
        <tbody id="tabela-funcionalidades" class="divide-y divide-gray-200">
        </tbody>
    </table>

    <div id="modal-cadastro" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center">
        <div class="bg-white p-6 rounded-md shadow-lg w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4">Nova Funcionalidade</h2>
            <form id="formFuncionalidade" class="space-y-4">
                <input type="hidden" name="id">
                <input type="hidden" name="imagem_existente">
                <div>
                    <input class="w-full p-2 border rounded-md" placeholder="Funcionalidade" name="nome" required>
                </div>
                <div>
                    <input class="w-full p-2 border rounded-md" placeholder="Relator" name="relator" id="relator" required>
                </div>
                <div>
                    <select class="w-full p-2 border rounded-md" name="prioridade" required>
                        <option value="Alta">Alta</option>
                        <option value="Média">Média</option>
                        <option value="Baixa">Baixa</option>
                    </select>
                </div>
                <div>
                    <textarea class="w-full p-2 border rounded-md" placeholder="Descrição" name="descricao"></textarea>
                </div>
                <div>
                    <label for="imagem" class="block text-gray-700 text-sm font-bold mb-2">Anexo:</label>
                    <input type="file" class="w-full" name="imagem" id="imagem">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="fecharModalCadastro()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md">Cancelar</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="visualizacao-detalhada" class="hidden flex gap-6 mt-6">
        <div id="detalhes-funcionalidade-container" class="bg-white p-6 rounded-md shadow-md flex-1">
            <h2 class="text-xl font-semibold mb-4">Detalhes da Funcionalidade</h2>
            <div id="detalhes-funcionalidade" class="space-y-2">
                <p><strong class="font-semibold">Nome:</strong> <span id="visualizar-nome"></span></p>
                <p><strong class="font-semibold">Relator:</strong> <span id="visualizar-relator"></span></p>
                <p><strong class="font-semibold">Prioridade:</strong> <span id="visualizar-prioridade"></span></p>
                <p><strong class="font-semibold">Descrição:</strong> <span id="visualizar-descricao"></span></p>
                <p><strong class="font-semibold">Criado em:</strong> <span id="visualizar-criado_em"></span></p>
                <p><strong class="font-semibold">Anexo:</strong> <span id="visualizar-imagem-link"></span></p>
            </div>
            <button onclick="fecharVisualizacaoDetalhada()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md mt-4 inline-block">Fechar Detalhes</button>
        </div>
        <div id="chat-gpt-container" class="bg-white p-6 rounded-md shadow-md flex-1">
            <h2 class="text-xl font-semibold mb-4">Prompt ChatGPT</h2>
            <textarea id="prompt-visualizacao" class="w-full p-2 border rounded-md mb-4" placeholder="Digite seu prompt relacionado a esta funcionalidade..." readonly></textarea>
            <button onclick="enviarPromptVisualizacao()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md">Gerar Casos de Teste</button>
            <div id="resposta-visualizacao" class="mt-4 p-3 border rounded-md bg-gray-100 whitespace-pre-wrap overflow-y-auto max-h-96">A resposta aparecerá aqui...</div>
        </div>
    </div>

    <script>
        const modalCadastro = document.getElementById('modal-cadastro');
        const visualizacaoDetalhada = document.getElementById('visualizacao-detalhada');
        const detalhesFuncionalidadeContainer = document.getElementById('detalhes-funcionalidade');
        const tabela = document.getElementById('tabela-funcionalidades');
        const visualizarNome = document.getElementById('visualizar-nome');
        const visualizarRelator = document.getElementById('visualizar-relator');
        const visualizarPrioridade = document.getElementById('visualizar-prioridade');
        const visualizarDescricao = document.getElementById('visualizar-descricao');
        const visualizarCriadoEm = document.getElementById('visualizar-criado_em');
        const visualizarImagemLink = document.getElementById('visualizar-imagem-link');
        const promptVisualizacaoInput = document.getElementById('prompt-visualizacao');
        const respostaVisualizacaoDiv = document.getElementById('resposta-visualizacao');
        const formFuncionalidade = document.getElementById('formFuncionalidade');
        const modalTitle = document.querySelector('#modal-cadastro h2');
        const salvarButton = document.querySelector('#formFuncionalidade button[type="submit"]');
        const idFuncionalidadeEdicaoInput = formFuncionalidade.querySelector('[name="id"]');

        function abrirModalCadastro() {
            modalTitle.textContent = 'Nova Funcionalidade';
            salvarButton.textContent = 'Salvar';
            formFuncionalidade.reset();
            idFuncionalidadeEdicaoInput.value = '';
            const imagemExistenteInput = formFuncionalidade.querySelector('[name="imagem_existente"]');
            if (imagemExistenteInput) {
                imagemExistenteInput.remove();
            }
            modalCadastro.classList.remove('hidden');
        }

        function fecharModalCadastro() {
            modalCadastro.classList.add('hidden');
        }

        function abrirVisualizacaoDetalhada(funcionalidade) {
            visualizarNome.textContent = funcionalidade.nome;
            visualizarRelator.textContent = funcionalidade.relator;
            visualizarPrioridade.textContent = funcionalidade.prioridade;
            visualizarDescricao.textContent = funcionalidade.descricao || 'Nenhuma descrição';
            visualizarCriadoEm.textContent = new Date(funcionalidade.criado_em).toLocaleDateString();

            if (funcionalidade.imagem) {
                const link = document.createElement('a');
                link.href = `http://localhost:8000/uploads/${funcionalidade.imagem.split('/').pop()}`;
                link.textContent = funcionalidade.imagem.split('/').pop();
                link.target = '_blank';
                visualizarImagemLink.innerHTML = '';
                visualizarImagemLink.appendChild(link);
            } else {
                visualizarImagemLink.textContent = 'Nenhum anexo';
            }

            promptVisualizacaoInput.value = funcionalidade.descricao || '';
            visualizacaoDetalhada.dataset.currentId = funcionalidade.id; // Armazena o ID
            visualizacaoDetalhada.classList.remove('hidden');
        }

        function fecharVisualizacaoDetalhada() {
            visualizacaoDetalhada.classList.add('hidden');
            delete visualizacaoDetalhada.dataset.currentId; // Limpa o ID armazenado
        }

        function abrirModalEdicao(funcionalidade) {
            modalTitle.textContent = 'Editar Funcionalidade';
            salvarButton.textContent = 'Atualizar';
            formFuncionalidade.reset();

            formFuncionalidade.querySelector('[name="nome"]').value = funcionalidade.nome;
            formFuncionalidade.querySelector('[name="relator"]').value = funcionalidade.relator;
            formFuncionalidade.querySelector('[name="prioridade"]').value = funcionalidade.prioridade;
            formFuncionalidade.querySelector('[name="descricao"]').value = funcionalidade.descricao || '';
            idFuncionalidadeEdicaoInput.value = funcionalidade.id || '';

            let imagemInput = formFuncionalidade.querySelector('[name="imagem"]');
            let imagemExistenteInput = formFuncionalidade.querySelector('[name="imagem_existente"]');
            let imagemPreview = formFuncionalidade.querySelector('.imagem-preview'); // Seletor para a div de preview

            if (funcionalidade.imagem) {
                const nomeArquivo = funcionalidade.imagem.split('/').pop();
                if (!imagemExistenteInput) {
                    imagemExistenteInput = document.createElement('input');
                    imagemExistenteInput.type = 'hidden';
                    imagemExistenteInput.name = 'imagem_existente';
                    formFuncionalidade.appendChild(imagemExistenteInput);
                }
                imagemExistenteInput.value = nomeArquivo;

                // Exibe o nome do arquivo abaixo do input de imagem
                if (!imagemPreview) {
                    imagemPreview = document.createElement('div');
                    imagemPreview.className = 'imagem-preview text-sm text-gray-500 mt-1';
                    imagemInput.parentNode.insertBefore(imagemPreview, imagemInput.nextSibling);
                }
                imagemPreview.textContent = `Arquivo selecionado: ${nomeArquivo}`;
            } else if (imagemExistenteInput) {
                imagemExistenteInput.remove();
                if (imagemPreview) {
                    imagemPreview.remove(); // Remove o preview se não houver imagem
                }
            } else if (imagemPreview){
                imagemPreview.remove();
            }

            // Limpa o valor do input de arquivo para evitar envios incorretos
            imagemInput.value = '';

            modalCadastro.classList.remove('hidden');
        }

        async function carregarFuncionalidades() {
            const res = await fetch("http://localhost:8000/funcionalidades");
            const funcionalidades = await res.json();
            tabela.innerHTML = funcionalidades.map(f => {
                // Escapa aspas simples e duplas para o JSON.stringify em atributos HTML
                const funcionalidadeString = JSON.stringify(f).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                return `
                    <tr>
                        <td class="p-3">${f.nome}</td>
                        <td class="p-3">${f.prioridade}</td>
                        <td class="p-3">${f.relator}</td>
                        <td class="p-3">${new Date(f.criado_em).toLocaleDateString()}</td>
                        <td class="p-3 flex gap-2 justify-center items-center">
                            <button title="Visualizar" onclick='abrirVisualizacaoDetalhada(${funcionalidadeString})' class="text-blue-600 hover:text-blue-800 p-1 rounded-md">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                                </svg>
                            </button>
                            <button title="Editar" onclick='abrirModalEdicao(${funcionalidadeString})' class="text-yellow-600 hover:text-yellow-800 p-1 rounded-md">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                </svg>
                            </button>
                            <button title="Deletar" onclick='deletarFuncionalidade(${f.id})' class="text-red-600 hover:text-red-800 p-1 rounded-md">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.56 0c1.153 0 2.242.078 3.288.227m8.978 0A48.966 48.966 0 0 1 12 4.5c-2.291 0-4.545.232-6.75.673m13.5 0c-.341.053-.68.107-1.022.165M5.78 5.79L4.247 3.337A1.875 1.875 0 0 1 6.12 2.079h11.76a1.875 1.875 0 0 1 1.874 1.257l-1.532 2.453M12 14.25v-2.625" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function deletarFuncionalidade(id) {
            if (confirm('Tem certeza que deseja deletar esta funcionalidade? Esta ação não pode ser desfeita.')) {
                try {
                    const response = await fetch(`http://localhost:8000/funcionalidades/${id}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('Funcionalidade deletada com sucesso!');
                        carregarFuncionalidades(); // Recarrega a lista
                        
                        // Se a visualização detalhada estiver aberta e for o item deletado, fechar
                        if (!visualizacaoDetalhada.classList.contains('hidden') && visualizacaoDetalhada.dataset.currentId == String(id)) {
                            fecharVisualizacaoDetalhada();
                        }
                    } else {
                        const errorData = await response.json().catch(() => ({ detail: response.statusText }));
                        alert(`Erro ao deletar funcionalidade: ${errorData.detail || response.statusText}`);
                        console.error('Erro ao deletar:', errorData);
                    }
                } catch (error) {
                    alert('Erro de conexão ao tentar deletar funcionalidade.');
                    console.error('Erro de conexão:', error);
                }
            }
        }

        document.getElementById('formFuncionalidade').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = new FormData(e.target);
    const idEdicao = form.get('id');
    let url = "http://localhost:8000/funcionalidades";
    let method = 'POST';

    if (idEdicao) {
        url = `http://localhost:8000/funcionalidades/${idEdicao}`;
        method = 'PUT';
    }

    // Remove o campo 'imagem' se nenhum novo arquivo foi selecionado
    const imagemInput = document.querySelector('[name="imagem"]');
    if (imagemInput && imagemInput.files.length === 0) {
        form.delete('imagem');
    }

    const response = await fetch(url, {
        method: method,
        body: form
    });

    if (response.ok) {
        e.target.reset();
        fecharModalCadastro();
        carregarFuncionalidades();
        alert(`Funcionalidade ${idEdicao ? 'atualizada' : 'cadastrada'} com sucesso!`);
    } else {
        const errorData = await response.json();
        alert(`Erro ao ${idEdicao ? 'atualizar' : 'cadastrar'} funcionalidade: ${errorData.detail || response.statusText}`);
        console.error(errorData);
    }
});

        async function enviarPromptVisualizacao() {
            const prompt = promptVisualizacaoInput.value;
            respostaVisualizacaoDiv.textContent = "Pensando...";

            try {
                const response = await fetch("http://localhost:8000/generate_bdd", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ user_story: prompt })
                });

                const data = await response.json();

                if (response.ok) {
                    respostaVisualizacaoDiv.textContent = data.bdd_scenarios || "Resposta gerada.";
                } else {
                    respostaVisualizacaoDiv.textContent = `Erro na requisição: ${data.detail || response.statusText}`;
                }
            } catch (error) {
                respostaVisualizacaoDiv.textContent = "Erro ao comunicar com o servidor.";
                console.error(error);
            }
        }

        window.onload = carregarFuncionalidades;
    </script>

</body>
</html>
